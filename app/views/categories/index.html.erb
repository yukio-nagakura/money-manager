<h2>ã‚«ãƒ†ã‚´ãƒªä¸€è¦§</h2>

<h3>åå…¥ã‚«ãƒ†ã‚´ãƒª</h3>
<ul>
  <% Category.roots.where(transaction_type: "income").each do |parent| %>
    <%= render_category_tree(parent) %>
  <% end %>    
</ul>

<h3>æ”¯å‡ºã‚«ãƒ†ã‚´ãƒª</h3>
<ul>
  <% Category.roots.where(transaction_type: "expense").each do |parent| %>
    <%= render_category_tree(parent) %>
  <% end %>  
</ul> 

<hr>

<h2>ã‚«ãƒ†ã‚´ãƒªè¿½åŠ </h2>

<%= form_with model: @category, url: categories_path, local: true do |f| %>

  <div>
    <%= f.label :transaction_type, "ç¨®åˆ¥(åå…¥ or æ”¯å‡º)" %><br>
    <%= f.select :transaction_type,
             [["åå…¥", "income"], ["æ”¯å‡º", "expense"]],
             { prompt: "-- ç¨®åˆ¥ã‚’é¸æŠ --" },
             { id: "transaction_type_select" } %>
  </div>

  <br>

  <div>
    <%= f.label :ancestry, "è¦ªã‚«ãƒ†ã‚´ãƒª(ä»»æ„)" %><br>
    <select name="category[ancestry]" id="parent_category_select">
      <option value="">-- è¦ªã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠ --</option>
      <% Category.all.each do |c| %>
        <option value="<%= c.id %>" data-transaction-type="<%= c.transaction_type %>">
          <%= c.name %>
        </option>
      <% end %>
    </select>
  </div>

  <br>

  <div>
    <%= f.label :name, "ã‚«ãƒ†ã‚´ãƒªå" %><br>
    <%= f.text_field :name %>
  </div>

  <br>

  <div>
    <%= f.submit "è¿½åŠ ã™ã‚‹" %>
  </div>
<% end %>

<script>
  document.addEventListener("turbo:load", function() {
    const typeSelect = document.getElementById("transaction_type_select");
    const parentSelect = document.getElementById("parent_category_select");

    // æœ€åˆã«ã‚ã‚‹å…¨ã‚«ãƒ†ã‚´ãƒªã‚’ä¿å­˜ã—ã¦ãŠã
    const allOptions = Array.from(parentSelect.options).slice(1);

    typeSelect.addEventListener("change", function () {
      const selectedType = this.value;

      // ãƒªã‚»ãƒƒãƒˆ
      parentSelect.innerHTML = '<option value="">-- è¦ªã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠ --</option>';

      // ğŸ”´ ä¿®æ­£ã“ã“ï¼ dataset.transactionType ã«å¤‰æ›´ï¼
      const filtered = allOptions.filter(opt => opt.dataset.transactionType === selectedType);

      filtered.forEach(opt => {
        parentSelect.appendChild(opt.cloneNode(true));
      });
    });
  });
</script>
