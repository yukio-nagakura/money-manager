<h1>å–å¼•ã®ç™»éŒ²</h1>

<%= form_with model: @transaction, local: true do |f| %>

  <div>
    <%= f.label :date, "æ—¥ä»˜ï¼š" %><br>
    <%= f.date_field :date, value: Date.today %>
  </div>
  <br>
  <div>
    <%= f.label :transaction_type, "å–å¼•ã‚¿ã‚¤ãƒ—ï¼š" %><br>
    <%= f.radio_button :transaction_type, "income", id: "radio_income" %>
    <%= f.label :transaction_type_income, "åå…¥" %>
    <%= f.radio_button :transaction_type, "expense", id: "radio_expense" %>
    <%= f.label :transaction_type_expense, "æ”¯å‡º" %>
  </div>
	<div>
		<%= f.label :category_id, "ã‚«ãƒ†ã‚´ãƒªï¼š" %><br>
		<select id="category_select" name="transaction[category_id]">
			<option value="">-- ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠ --</option>
			<% Category.all.each do |c| %>
				<option value="<%= c.id %>" data-type="<%= c.transaction_type %>"
					<%= "selected" if @transaction.category_id.to_s == c.id.to_s %>>
					<%= c.name %>
				</option>
			<% end %>
		</select>
		<% if @transaction.errors[:category_id].any? %>
			<div style="color: red;"><%= @transaction.errors[:category_id].first %></div>
		<% end %>
	</div>
  <br>
  <div>
    <%= f.label :amount, "é‡‘é¡ï¼š" %><br>
    <%= f.number_field :amount, step: 1 %>
  </div>
  <br>
  <div>
    <%= f.label :note, "ãƒ¡ãƒ¢ï¼š" %><br>
    <%= f.text_field :note %>
  </div>
  <br>
  <div>
    <%= f.submit "ç™»éŒ²ã™ã‚‹" %>
  </div>
	
	<% if f.object.errors.any? %>
		<div style="color: red;">
			<h2>ã‚¨ãƒ©ãƒ¼ãŒã‚ã‚Šã¾ã™ï¼š</h2>
			<ul>
				<% f.object.errors.full_messages.each do |msg| %>
					<li><%= msg %></li>
				<% end %>
			</ul>
		</div>
	<% end %>

<% end %>

<p><%= link_to "ä¸€è¦§ã«æˆ»ã‚‹", transactions_path %></p>

<% if notice %>
	<p style="coior: green;"><%= notice %></p>
<% end %>



<script>
  document.addEventListener("turbo:load", function () {
		const incomeRadio = document.getElementById("radio_income");
		const expenseRadio = document.getElementById("radio_expense");
		const categorySelect = document.getElementById("category_select");

		if (!incomeRadio || !expenseRadio || !categorySelect) {
			console.warn("ãƒ•ã‚©ãƒ¼ãƒ è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚IDãŒæ­£ã—ã„ã‹ç¢ºèªã—ã¦ã­");
			return;
		}

		const allOptions = Array.from(categorySelect.querySelectorAll("option")).slice(1); // æœ€åˆã® "--é¸æŠ--" ã‚’é™¤å¤–

		function filterCategories(type) {
			categorySelect.innerHTML = '<option value="">--ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠ--</option>';
			allOptions
				.filter(opt => opt.dataset.type === type)
				.forEach(opt => categorySelect.appendChild(opt.cloneNode(true)));
		}

		// ğŸ” ã¾ãšã‚¤ãƒ™ãƒ³ãƒˆç™»éŒ²
		incomeRadio.addEventListener("change", () => filterCategories("income"));
		expenseRadio.addEventListener("change", () => filterCategories("expense"));

		// âœ… æœ€å¾Œã«ä¸€åº¦ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’å‘¼ã¶ï¼ˆHTMLãŒå®Œå…¨ã«èª­ã¿è¾¼ã¾ã‚Œã¦ã‹ã‚‰ï¼‰
		setTimeout(() => {
			incomeRadio.checked = true;
			filterCategories("income");
		}, 0);
	});
</script>
